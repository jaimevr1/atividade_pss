# Test Design: Story 1.002 - Sistema de Atividades Compostas

Date: 2025-10-01
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 30
- **Unit tests**: 12 (40%)
- **Integration tests**: 12 (40%)
- **E2E tests**: 6 (20%)
- **Priority distribution**: P0: 14, P1: 11, P2: 5

**Approach**: Focus on state management, data flow integrity, and multi-module orchestration. Heavy integration testing for complex component interactions. E2E tests for critical student journeys.

---

## Test Scenarios by Acceptance Criteria

### AC-1: Activity Composition

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 1.002-UNIT-001 | Unit | P0 | Validate activity configuration schema | Schema validation is security-critical |
| 1.002-UNIT-002 | Unit | P0 | Sequence modules in specified order | Core sequencing logic |
| 1.002-UNIT-003 | Unit | P0 | Validate module compatibility | Prevent invalid combinations |
| 1.002-UNIT-004 | Unit | P1 | Calculate total estimated duration | Business requirement (±10%) |
| 1.002-INT-001 | Integration | P0 | Create 3-module composite activity | MVP baseline scenario |
| 1.002-INT-002 | Integration | P1 | Preview complete activity flow | Teacher UX requirement |
| 1.002-INT-003 | Integration | P1 | Create activity with incompatible modules | Validation edge case |
| 1.002-E2E-001 | E2E | P1 | Teacher creates and previews activity | Full creation flow |

**Coverage**: AC-1 fully covered with 8 scenarios

**Risk Mitigations**:
- SEQ-001 (module compatibility) → UNIT-003, INT-003
- PERF-003 (duration accuracy) → UNIT-004
- ORCH-001 (orchestrator complexity) → INT-001, INT-002

---

### AC-2: Inter-Module Data Flow

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 1.002-UNIT-005 | Unit | P0 | Transform data between module types | Core pipeline logic |
| 1.002-UNIT-006 | Unit | P0 | Validate data schema at boundaries | Security + reliability |
| 1.002-UNIT-007 | Unit | P0 | Handle missing/invalid data gracefully | Error resilience |
| 1.002-INT-004 | Integration | P0 | Pass data from BateriaRápida to AutoAvaliação | Real module flow |
| 1.002-INT-005 | Integration | P0 | Maintain context across all transitions | State consistency |
| 1.002-INT-006 | Integration | P0 | Preserve student responses for analytics | Data persistence |
| 1.002-INT-007 | Integration | P1 | Transform data with field mapping | Complex pipeline |
| 1.002-E2E-002 | E2E | P0 | Data flows correctly in full activity | Critical path |

**Coverage**: AC-2 fully covered with 8 scenarios

**Risk Mitigations**:
- FLOW-001 (pipeline failures) → UNIT-005, UNIT-006, UNIT-007, INT-004
- DATA-003 (intermediate data loss) → INT-006
- DATA-002 (state management) → INT-005

---

### AC-3: Progress Tracking

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 1.002-UNIT-008 | Unit | P0 | Calculate progress percentage | Display logic |
| 1.002-UNIT-009 | Unit | P0 | Track time spent per module | Analytics requirement |
| 1.002-UNIT-010 | Unit | P0 | Save intermediate progress state | Core persistence logic |
| 1.002-UNIT-011 | Unit | P1 | Detect and handle resume scenarios | Resumption logic |
| 1.002-INT-008 | Integration | P0 | Auto-save every 30 seconds | Reliability requirement |
| 1.002-INT-009 | Integration | P0 | Resume from any module position | Critical recovery path |
| 1.002-INT-010 | Integration | P0 | Show accurate progress indicator | Student UX |
| 1.002-INT-011 | Integration | P1 | Persist to Supabase on transitions | Backend integration |
| 1.002-E2E-003 | E2E | P0 | Resume interrupted activity | Critical student journey |
| 1.002-E2E-004 | E2E | P1 | Progress indicator updates correctly | Student feedback |

**Coverage**: AC-3 fully covered with 10 scenarios

**Risk Mitigations**:
- PERSIST-001 (resumption failures) → INT-008, INT-009, E2E-003
- DATA-002 (state management) → UNIT-010, INT-009
- UX-001 (progress clarity) → INT-010, E2E-004

---

## Performance & Security Tests

| ID | Level | Priority | Test Scenario | Target | Justification |
|---|---|---|---|---|---|
| 1.002-UNIT-012 | Unit | P0 | Data pipeline transformation time | <50ms | Performance req |
| 1.002-INT-012 | Integration | P0 | Orchestration overhead | <500ms | Performance req |
| 1.002-INT-013 | Integration | P0 | Module transition time | <1s | UX requirement |
| 1.002-INT-014 | Integration | P1 | 5-module activity performance | <20% degradation | Stress test |
| 1.002-E2E-005 | E2E | P2 | Duration estimation accuracy | ±10% | Business req |
| 1.002-SEC-001 | Security | P0 | Data pipeline injection attempts | Reject all | Security |
| 1.002-SEC-002 | Security | P0 | Activity config tampering detection | Alert on change | Security |
| 1.002-SEC-003 | Security | P1 | Student data isolation | No cross-student | Privacy |

**Coverage**: All performance and security requirements testable

**Risk Mitigations**:
- PERF-003 (duration accuracy) → E2E-005
- FLOW-001 (pipeline security) → SEC-001
- DATA-003 (data isolation) → SEC-003

---

## Risk Coverage Matrix

| Risk ID | Score | Related Test Scenarios | Coverage |
|---|---|---|---|
| DATA-002 | 9 | UNIT-010, INT-005, INT-009, E2E-003 | ✓ Full |
| FLOW-001 | 9 | UNIT-005, UNIT-006, UNIT-007, INT-004, SEC-001 | ✓ Full |
| PERSIST-001 | 6 | INT-008, INT-009, INT-011, E2E-003 | ✓ Full |
| SEQ-001 | 6 | UNIT-003, INT-003 | ✓ Baseline |
| PERF-003 | 6 | UNIT-004, E2E-005 | ✓ Full |
| UX-001 | 4 | INT-010, INT-013, E2E-004 | ✓ Full |
| DATA-003 | 4 | INT-006, INT-011 | ✓ Full |
| ORCH-001 | 4 | INT-001, INT-002, INT-012 | ✓ Full |

---

## Test Implementation Priority

### Phase 1: P0 Tests (Critical - Block Release)

**Unit Tests** (6-8 hours):
- 1.002-UNIT-001: Activity schema validation
- 1.002-UNIT-002: Module sequencing
- 1.002-UNIT-003: Module compatibility
- 1.002-UNIT-005: Data transformation
- 1.002-UNIT-006: Data schema validation
- 1.002-UNIT-007: Invalid data handling
- 1.002-UNIT-008: Progress calculation
- 1.002-UNIT-009: Time tracking
- 1.002-UNIT-010: Progress persistence
- 1.002-UNIT-012: Pipeline performance

**Integration Tests** (10-14 hours):
- 1.002-INT-001: 3-module activity creation
- 1.002-INT-004: BateriaRápida → AutoAvaliação flow
- 1.002-INT-005: Context maintenance across transitions
- 1.002-INT-006: Student response preservation
- 1.002-INT-008: Auto-save functionality
- 1.002-INT-009: Resume from any position
- 1.002-INT-010: Progress indicator accuracy
- 1.002-INT-012: Orchestration overhead
- 1.002-INT-013: Transition time

**E2E Tests** (6-8 hours):
- 1.002-E2E-002: Data flow in full activity
- 1.002-E2E-003: Resume interrupted activity

**Security Tests** (4-6 hours):
- 1.002-SEC-001: Pipeline injection attempts
- 1.002-SEC-002: Config tampering detection

**Total Phase 1**: ~26-36 hours

---

### Phase 2: P1 Tests (Important - Ship with Known Gaps)

**Unit Tests** (2-4 hours):
- 1.002-UNIT-004: Duration calculation
- 1.002-UNIT-011: Resume detection

**Integration Tests** (4-6 hours):
- 1.002-INT-002: Activity preview
- 1.002-INT-003: Incompatible modules validation
- 1.002-INT-007: Data transformation mapping
- 1.002-INT-011: Supabase persistence
- 1.002-INT-014: 5-module performance

**E2E Tests** (4-6 hours):
- 1.002-E2E-001: Teacher creation flow
- 1.002-E2E-004: Progress indicator updates

**Security Tests** (2-3 hours):
- 1.002-SEC-003: Student data isolation

**Total Phase 2**: ~12-19 hours

---

### Phase 3: P2 Tests (Nice to Have - Future Optimization)

**E2E Tests** (2-3 hours):
- 1.002-E2E-005: Duration estimation accuracy

**E2E Tests** (2-3 hours):
- 1.002-E2E-006: Concurrent activities (same student, multiple tabs)

**Total Phase 3**: ~4-6 hours

---

## Test Data Requirements

### Valid Activity Configurations

**Activity 1: Fluência Básica (3 modules)**
```json
{
  "activityId": "fluencia-divisao-semana-1",
  "name": "Prática de Divisão - Semana 1",
  "type": "fluencia",
  "estimatedDuration": 20,
  "modules": [
    {
      "moduleType": "EstadoJeremias",
      "config": { "context": "start", "duration": 2 },
      "order": 1
    },
    {
      "moduleType": "BateriaRápida",
      "config": { "operationType": "division", "quantity": 30 },
      "order": 2
    },
    {
      "moduleType": "AutoAvaliação",
      "config": { "concepts": ["divisão"] },
      "order": 3
    }
  ],
  "dataFlow": [
    {
      "from": "BateriaRápida",
      "to": "AutoAvaliação",
      "fields": ["score", "conceptsAttempted"]
    }
  ]
}
```

**Activity 2: Diagnóstico Completo (5 modules)**
```json
{
  "activityId": "diagnostico-operacoes",
  "name": "Diagnóstico de Operações",
  "type": "diagnostico",
  "estimatedDuration": 35,
  "modules": [
    {
      "moduleType": "EstadoJeremias",
      "config": { "context": "start", "duration": 2 },
      "order": 1
    },
    {
      "moduleType": "IdentificaOperação",
      "config": { "scenarios": 10 },
      "order": 2
    },
    {
      "moduleType": "BateriaRápida",
      "config": { "operationType": "mixed", "quantity": 20 },
      "order": 3
    },
    {
      "moduleType": "AutoAvaliação",
      "config": { "concepts": ["todas operações"] },
      "order": 4
    },
    {
      "moduleType": "EstadoJeremias",
      "config": { "context": "end", "duration": 2 },
      "order": 5
    }
  ],
  "dataFlow": [
    {
      "from": "IdentificaOperação",
      "to": "BateriaRápida",
      "fields": ["weakOperations"]
    },
    {
      "from": "BateriaRápida",
      "to": "AutoAvaliação",
      "fields": ["score", "operationBreakdown"]
    }
  ]
}
```

### Invalid Configurations (Error Testing)

**Invalid 1: Incompatible module sequence**
```json
{
  "activityId": "invalid-sequence",
  "modules": [
    {
      "moduleType": "AutoAvaliação",
      "order": 1
    },
    {
      "moduleType": "BateriaRápida",
      "order": 2
    }
  ]
}
```
*Error: AutoAvaliação requires data from previous module*

**Invalid 2: Circular data flow**
```json
{
  "activityId": "circular-flow",
  "modules": [...],
  "dataFlow": [
    { "from": "ModuleA", "to": "ModuleB" },
    { "from": "ModuleB", "to": "ModuleA" }
  ]
}
```
*Error: Circular dependency detected*

**Invalid 3: Missing module order**
```json
{
  "activityId": "missing-order",
  "modules": [
    { "moduleType": "BateriaRápida" },
    { "moduleType": "AutoAvaliação", "order": 2 }
  ]
}
```
*Error: All modules must have order field*

**Invalid 4: Data flow injection attempt**
```json
{
  "activityId": "injection-attempt",
  "dataFlow": [
    {
      "from": "BateriaRápida",
      "to": "AutoAvaliação",
      "fields": ["score", "<script>alert('XSS')</script>"]
    }
  ]
}
```
*Error: Invalid field name (security)*

### Progress State Test Data

**State 1: Activity in progress (module 2 of 3)**
```json
{
  "activityId": "fluencia-divisao-semana-1",
  "studentId": "student-123",
  "status": "in_progress",
  "currentModule": 2,
  "modules": [
    {
      "id": 1,
      "type": "EstadoJeremias",
      "status": "completed",
      "data": { "mood": "confident" },
      "completedAt": "2025-10-01T14:05:00Z"
    },
    {
      "id": 2,
      "type": "BateriaRápida",
      "status": "in_progress",
      "data": { "answersCompleted": 15, "score": 0.8 },
      "startedAt": "2025-10-01T14:05:30Z"
    },
    {
      "id": 3,
      "type": "AutoAvaliação",
      "status": "not_started",
      "data": null
    }
  ],
  "startedAt": "2025-10-01T14:00:00Z",
  "lastSavedAt": "2025-10-01T14:08:00Z",
  "estimatedEndAt": "2025-10-01T14:20:00Z"
}
```

**State 2: Resume detection (browser closed)**
```json
{
  "activityId": "diagnostico-operacoes",
  "studentId": "student-456",
  "status": "in_progress",
  "currentModule": 3,
  "modules": [
    { "id": 1, "status": "completed", "data": {...} },
    { "id": 2, "status": "completed", "data": {...} },
    { "id": 3, "status": "in_progress", "data": { "partial": true } },
    { "id": 4, "status": "not_started", "data": null },
    { "id": 5, "status": "not_started", "data": null }
  ],
  "startedAt": "2025-10-01T13:00:00Z",
  "lastSavedAt": "2025-10-01T13:25:00Z",
  "sessionInterrupted": true
}
```

---

## Mock/Stub Strategy

### Unit Test Mocks

**ActivityOrchestrator mocks**:
- Mock ModuleSequencer for transition logic
- Mock DataPipeline for transformation
- Mock ProgressTracker for persistence
- Stub Supabase client

**ModuleSequencer mocks**:
- Stub module compatibility matrix
- Mock module validators

**DataPipeline mocks**:
- Mock schema validators
- Stub transformation functions
- Mock sanitization layer

**ProgressTracker mocks**:
- Mock localStorage
- Stub Supabase persistence
- Fake timestamp generator

### Integration Test Mocks

**Minimal mocking** (real components preferred):
- Mock Supabase backend (use test instance)
- Mock time functions for auto-save testing
- Use real modules (M1, M5, M14) via US-001
- Real state management (critical to test)

### E2E Test Mocks

**No mocking** (real system):
- Real ActivityOrchestrator
- Real DataPipeline
- Real modules
- Real state persistence (test Supabase)
- Mock only: External analytics (if applicable)

---

## Test Environment Requirements

### Unit Tests
- **Framework**: Vitest
- **State testing**: @testing-library/react for state hooks
- **Time mocking**: vi.useFakeTimers for auto-save
- **Storage mocking**: localStorage mock

### Integration Tests
- **Framework**: Vitest + React Testing Library
- **Database**: Supabase test instance
- **State persistence**: Real localStorage + test Supabase
- **Module testing**: Import from US-001 test utils

### E2E Tests
- **Framework**: Playwright
- **Browsers**: Chromium, Firefox
- **Viewports**: Desktop (1920x1080), Tablet (1024x768)
- **Network**: Fast 3G, Offline (for resumption tests)
- **Database**: Supabase test instance (isolated per test)

### Performance Tests
- **Profiling**: React DevTools Profiler
- **Memory**: Chrome DevTools Memory
- **Timing**: Performance API
- **Load testing**: k6 (future - concurrent students)

### Security Tests
- **Static analysis**: ESLint security plugins
- **Dynamic testing**: Manual injection attempts
- **Data validation**: Schema violation tests

---

## Continuous Integration Strategy

### Pre-commit Hooks
- ESLint + Prettier
- Type checking (TypeScript)
- Unit tests for changed files

### PR Pipeline
1. **Fast checks** (~3 min):
   - Lint
   - Type check
   - Unit tests (all)
2. **Integration tests** (~8 min):
   - Component integration
   - State management tests
   - Data flow tests
3. **Security scan** (~3 min):
   - npm audit
   - ESLint security rules
4. **Build verification** (~2 min):
   - Production build
   - Bundle size check

### Main Branch Pipeline
- All PR checks +
- E2E tests (~12 min)
- Performance benchmarks (~5 min)
- Security testing (~8 min)
- Coverage report (Codecov)

---

## Test Quality Metrics

### Coverage Targets

**Overall**: 90%+ (per DoD)

**By Component**:
- ActivityOrchestrator: 95%+ (critical orchestration)
- ModuleSequencer: 95%+ (sequencing logic)
- DataPipeline: 95%+ (data transformation security)
- ProgressTracker: 90%+ (persistence logic)

**By Type**:
- Statements: 90%+
- Branches: 85%+
- Functions: 90%+
- Lines: 90%+

### Performance Targets

**Test execution time**:
- Unit tests: <8 seconds (all)
- Integration tests: <40 seconds (all)
- E2E tests: <3 minutes (all)

**Build time**:
- Development build: <5 seconds
- Production build: <15 seconds

### Quality Gates

**Automated checks pass**:
- ✓ All tests pass (100%)
- ✓ Coverage ≥ 90%
- ✓ No security vulnerabilities (high/critical)
- ✓ Performance targets met
- ✓ State management tests pass (critical)

---

## Recommended Test Execution Order

**Local Development** (fast feedback loop):
1. Unit tests for current file (watch mode)
2. Related integration tests
3. Pre-commit: All unit tests

**CI/CD Pipeline** (optimized for failure detection):
1. **Fail Fast** (0-3 min):
   - P0 unit tests
   - Lint + type check
2. **Core Functionality** (3-12 min):
   - All unit tests
   - P0 integration tests
   - State management tests
3. **Full Validation** (12-25 min):
   - All integration tests
   - E2E P0 tests
   - Performance tests
4. **Comprehensive** (25-40 min):
   - All E2E tests
   - Security tests
   - Duration accuracy validation

**Pre-Release** (full suite):
- All tests (P0, P1, P2)
- Full performance benchmarking
- Cross-browser E2E
- Load testing (concurrent students)

---

## Test Maintenance Strategy

### Test Reviews
- Code review includes tests
- Test coverage tracked in PR
- Flaky tests fixed within 24h or disabled
- State management tests reviewed by architect

### Test Refactoring
- Extract activity fixtures to shared module
- Create test helpers for state creation
- Page Object Model for E2E activity flows
- Custom matchers for state assertions

### Test Documentation
- Each test has clear Given-When-Then comment
- Complex state setups documented
- Activity configurations documented
- Data flow scenarios explained

---

## Future Test Enhancements

**After MVP** (Epic 1 complete):
- Visual regression for progress indicators (Percy)
- Accessibility automation for activity flow
- Load testing for concurrent students (k6)
- Mutation testing for state logic (Stryker)
- Contract testing for data pipeline

**Performance Monitoring** (Post-launch):
- Real User Monitoring for activity completion
- Synthetic monitoring for key flows
- Duration estimation accuracy tracking
- Error rate alerting

---

## Appendix: Test Scenario IDs

### Naming Convention
```
{epic}.{story}-{LEVEL}-{SEQ}
Example: 1.002-UNIT-001
```

**LEVEL**:
- UNIT: Unit test
- INT: Integration test
- E2E: End-to-end test
- SEC: Security test
- PERF: Performance test

**SEQ**: Sequential number starting from 001

### Full Test ID Index

**Unit (12)**: 1.002-UNIT-001 through 1.002-UNIT-012
**Integration (14)**: 1.002-INT-001 through 1.002-INT-014
**E2E (6)**: 1.002-E2E-001 through 1.002-E2E-006
**Security (3)**: 1.002-SEC-001 through 1.002-SEC-003

**Total**: 35 test scenarios (30 functional + 3 security + 2 performance-focused)

---

## State Management Test Scenarios (Critical Focus)

### State Transition Tests

| Test ID | Scenario | Expected Outcome |
|---|---|---|
| 1.002-STATE-001 | Module 1 completes → Module 2 starts | State: module[0].completed, module[1].in_progress |
| 1.002-STATE-002 | Auto-save during module 2 | State persisted to localStorage + Supabase |
| 1.002-STATE-003 | Browser refresh during module 3 | State recovered, resume at module 3 |
| 1.002-STATE-004 | Network failure during save | Local state preserved, retry on reconnect |
| 1.002-STATE-005 | Concurrent tabs (same activity) | Conflict detected, latest state wins |
| 1.002-STATE-006 | Module error during activity | Activity state safe, error isolated |
| 1.002-STATE-007 | Data pipeline failure | Default values used, state consistent |
| 1.002-STATE-008 | Activity completion | All states marked completed, final save |

**Note**: State management tests are integrated into main test scenarios but called out here for visibility due to critical importance.
