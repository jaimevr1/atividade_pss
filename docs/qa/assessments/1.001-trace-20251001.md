# Requirements Traceability Matrix: Story 1.001 - Sistema Runtime de Módulos

Date: 2025-10-01
Reviewer: Quinn (Test Architect)

## Story: 1.001 - Sistema Runtime de Módulos

**Status**: PLANNING - Traceability baseline for implementation

---

## Coverage Summary

- **Total Requirements**: 12 (3 ACs with sub-requirements + 4 performance + 4 DoD + 1 accessibility)
- **Fully Covered**: 10 (83%)
- **Partially Covered**: 2 (17%)
- **Not Covered**: 0 (0%)

**Overall Trace Status**: STRONG - All requirements traceable to planned tests

---

## Requirement Mappings

### AC-1: JSON Configuration Loading

#### AC-1.1: Parse configuration without errors

**Coverage**: FULL

**Test Mappings**:

- **Unit Test**: `1.001-UNIT-001` - Validate correct JSON schema parsing
  - **Given**: Valid module configuration JSON (BateriaRápida example)
  - **When**: JSON is parsed by ModuleValidator
  - **Then**: Returns parsed object with no errors, all fields typed correctly

- **Integration Test**: `1.001-INT-001` - Load ModuleRuntime with valid config
  - **Given**: Complete valid configuration for all 3 MVP modules
  - **When**: ModuleRuntime.load(config) is called
  - **Then**: Configuration is successfully loaded into runtime state

#### AC-1.2: Validate against module schema

**Coverage**: FULL

**Test Mappings**:

- **Unit Test**: `1.001-UNIT-002` - Reject invalid JSON structure
  - **Given**: JSON with missing required fields (moduleType, config)
  - **When**: Validation is performed
  - **Then**: Returns validation error with specific field names

- **Unit Test**: `1.001-UNIT-003` - Validate moduleType whitelist
  - **Given**: JSON with unknown moduleType ("HackerModule")
  - **When**: Validation is performed
  - **Then**: Rejects with "Unknown module type" error (SECURITY)

- **Unit Test**: `1.001-UNIT-004` - Validate config parameter types
  - **Given**: Config with wrong types (string instead of number)
  - **When**: Schema validation runs
  - **Then**: Returns type mismatch error with expected vs actual types

- **Security Test**: `1.001-SEC-001 through SEC-005` - XSS, injection, JSON bomb
  - **Given**: Malicious payloads in configuration strings
  - **When**: Validation and rendering occur
  - **Then**: All malicious inputs are rejected or sanitized

#### AC-1.3: Load appropriate React component

**Coverage**: FULL

**Test Mappings**:

- **Unit Test**: `1.001-UNIT-006` - ModuleLoader resolves correct component
  - **Given**: moduleType "BateriaRápida", "IdentificaOperação", "AutoAvaliação"
  - **When**: ModuleLoader.resolveComponent(type) is called
  - **Then**: Returns correct React component for each type

- **Integration Test**: `1.001-INT-003/004/005` - Render all 3 MVP modules
  - **Given**: Valid configuration for each MVP module type
  - **When**: Module is loaded and rendered
  - **Then**: Correct component appears in DOM with expected structure

#### AC-1.4: Initialize module state correctly

**Coverage**: FULL

**Test Mappings**:

- **Integration Test**: `1.001-INT-002` - Initialize module state correctly
  - **Given**: Configuration with specific parameters (quantity: 30, timeLimit: null)
  - **When**: Module initializes
  - **Then**: Module state contains correct values from config, defaults applied where null

- **E2E Test**: `1.001-E2E-001` - Complete config-to-render flow
  - **Given**: Teacher provides JSON configuration
  - **When**: System processes from parsing through initialization
  - **Then**: Module renders with correct initial state visible to student

---

### AC-2: Dynamic Component Rendering

#### AC-2.1: Display correct UI based on module type

**Coverage**: FULL

**Test Mappings**:

- **Integration Test**: `1.001-INT-003` - Render BateriaRápida module (M1)
  - **Given**: BateriaRápida configuration
  - **When**: Module renders
  - **Then**: UI shows division problems, 30 questions, timer interface (if applicable)

- **Integration Test**: `1.001-INT-004` - Render IdentificaOperação module (M5)
  - **Given**: IdentificaOperação configuration
  - **When**: Module renders
  - **Then**: UI shows scenario descriptions, operation selection interface

- **Integration Test**: `1.001-INT-005` - Render AutoAvaliação module (M14)
  - **Given**: AutoAvaliação configuration
  - **When**: Module renders
  - **Then**: UI shows self-assessment questions, response inputs

- **E2E Test**: `1.001-E2E-002` - Student interacts with rendered module
  - **Given**: Any rendered module
  - **When**: Student clicks, types, or submits answers
  - **Then**: UI responds appropriately per module type

#### AC-2.2: Apply configuration parameters

**Coverage**: FULL

**Test Mappings**:

- **Unit Test**: `1.001-UNIT-007` - Apply configuration parameters
  - **Given**: Config with specific params (operationType: "division", quantity: 30)
  - **When**: Parameters are applied to component
  - **Then**: Component props match config values

- **Integration Test**: `1.001-INT-003/004/005` - Verify params applied in rendered modules
  - **Given**: Configuration with varied parameters
  - **When**: Module renders
  - **Then**: UI reflects configured parameters (correct operation, question count, etc.)

#### AC-2.3: Maintain responsive design (1024px+)

**Coverage**: FULL

**Test Mappings**:

- **Integration Test**: `1.001-INT-006` - Responsive design 1024px+
  - **Given**: Module rendered at 1024px, 1366px, 1920px viewports
  - **When**: Viewport size changes
  - **Then**: Layout adapts properly, no horizontal scroll, readable text

#### AC-2.4: Follow design system (colors, typography)

**Coverage**: PARTIAL

**Test Mappings**:

- **Unit Test**: `1.001-UNIT-008` - Verify design system token usage
  - **Given**: Component using design tokens
  - **When**: Component renders
  - **Then**: CSS uses design system variables (not hard-coded colors)

- **Integration Test**: `1.001-INT-007` - Design system compliance (visual regression)
  - **Given**: Rendered module
  - **When**: Visual snapshot is taken
  - **Then**: Matches approved design (future: automated visual testing)

**Gap**: Visual regression testing is P2, manual verification needed initially

---

### AC-3: Error Handling

#### AC-3.1: Display friendly error message to user

**Coverage**: FULL

**Test Mappings**:

- **Unit Test**: `1.001-UNIT-010` - Generate friendly error messages
  - **Given**: Various error types (network, parsing, validation)
  - **When**: Error message is generated
  - **Then**: User-friendly message returned (no technical jargon, actionable guidance)

- **Integration Test**: `1.001-INT-008` - Error boundary prevents crash
  - **Given**: Component throws error during render
  - **When**: Error is caught
  - **Then**: Friendly error UI displayed instead of white screen

- **E2E Test**: `1.001-E2E-004` - User recovers from corrupted config
  - **Given**: Invalid configuration submitted
  - **When**: Error occurs
  - **Then**: User sees helpful message, can correct and retry

#### AC-3.2: Log technical details for debugging

**Coverage**: FULL

**Test Mappings**:

- **Unit Test**: `1.001-UNIT-011` - Log technical error details
  - **Given**: Error with stack trace and context
  - **When**: Logging function is called
  - **Then**: Structured log created with error type, stack, config, timestamp

- **Integration Test**: `1.001-INT-008` - Error boundary logs to service
  - **Given**: Component error caught by boundary
  - **When**: Error handling executes
  - **Then**: Error logged to external service (Sentry, LogRocket) with full context

#### AC-3.3: Gracefully fallback to safe state

**Coverage**: FULL

**Test Mappings**:

- **Integration Test**: `1.001-INT-008` - Error boundary prevents crash
  - **Given**: Module fails during initialization
  - **When**: Error boundary activates
  - **Then**: Safe fallback UI displayed, app remains functional

- **E2E Test**: `1.001-E2E-003` - Graceful degradation on network failure
  - **Given**: Network connection lost during module load
  - **When**: Load fails
  - **Then**: System shows offline message, other modules still work

#### AC-3.4: Allow user to continue with other modules

**Coverage**: FULL

**Test Mappings**:

- **Integration Test**: `1.001-INT-009` - User can continue with other modules
  - **Given**: Module 1 fails, modules 2 and 3 loaded
  - **When**: Error occurs in module 1
  - **Then**: Modules 2 and 3 remain functional, user can interact with them

- **E2E Test**: `1.001-E2E-003` - Graceful degradation on network failure
  - **Given**: One module fails to load
  - **When**: User navigates to other modules
  - **Then**: Other modules load and function normally

---

### Performance Requirements

#### PERF-1: Module initialization <2 seconds

**Coverage**: FULL

**Test Mappings**:

- **Unit Test**: `1.001-UNIT-014` - Module initialization time
  - **Given**: Module configuration
  - **When**: Initialization is timed
  - **Then**: Completes in <2000ms (measured, not mocked)

- **E2E Test**: `1.001-E2E-005` - Network throttling (3G)
  - **Given**: 3G network simulation
  - **When**: Module initializes
  - **Then**: Still completes in <3 seconds (acceptable degradation)

#### PERF-2: Configuration validation <100ms

**Coverage**: FULL

**Test Mappings**:

- **Unit Test**: `1.001-UNIT-013` - JSON validation performance
  - **Given**: Various config sizes (small, medium, large)
  - **When**: Validation is timed
  - **Then**: Completes in <100ms for all sizes

#### PERF-3: Memory usage <50MB per module

**Coverage**: FULL

**Test Mappings**:

- **Integration Test**: `1.001-INT-011` - Memory usage per module
  - **Given**: Module fully loaded and rendered
  - **When**: Memory snapshot is taken
  - **Then**: Module heap size <50MB

- **Integration Test**: `1.001-INT-013` - 5 modules stress test
  - **Given**: 5 modules loaded simultaneously
  - **When**: Memory is profiled
  - **Then**: Total memory <250MB, no memory leaks over 5 minutes

#### PERF-4: Graceful degradation on slow connections

**Coverage**: FULL

**Test Mappings**:

- **E2E Test**: `1.001-E2E-005` - Network throttling (3G)
  - **Given**: Slow 3G network (750Kbps, 100ms latency)
  - **When**: Module loads
  - **Then**: Loading indicators shown, eventual success, no timeout errors

---

### Definition of Done Requirements

#### DoD-1: Supports all 3 MVP module types (M1, M5, M14)

**Coverage**: FULL

**Test Mappings**:

- **Integration Test**: `1.001-INT-003` - BateriaRápida (M1)
- **Integration Test**: `1.001-INT-004` - IdentificaOperação (M5)
- **Integration Test**: `1.001-INT-005` - AutoAvaliação (M14)
  - **Given**: Configuration for each MVP module
  - **When**: Each module is loaded
  - **Then**: All 3 render successfully with correct functionality

#### DoD-2: JSON schema validation working

**Coverage**: FULL

**Test Mappings**: All `1.001-UNIT-001 through UNIT-005` cover validation

#### DoD-3: Error boundaries prevent crashes

**Coverage**: FULL

**Test Mappings**: All `1.001-INT-008, INT-009, E2E-003, E2E-004` cover error handling

#### DoD-4: Performance targets met

**Coverage**: FULL

**Test Mappings**: All `1.001-UNIT-013, UNIT-014, INT-011, E2E-005` cover performance

---

### Additional Requirements

#### Accessibility: WCAG AA compliance

**Coverage**: PARTIAL

**Test Mappings**:

- **E2E Test**: Accessibility audit (future - not in current test design)
  - **Given**: Rendered module
  - **When**: axe-core audit runs
  - **Then**: No WCAG AA violations

**Gap**: Automated accessibility testing not yet planned
**Recommendation**: Add `1.001-E2E-006` for axe-core audit (P1)

---

## Critical Gaps Analysis

### Gap 1: Visual Regression Testing

**Requirement**: AC-2.4 - Follow design system (colors, typography)
**Current Coverage**: PARTIAL (manual verification only)
**Severity**: LOW (cosmetic, caught in code review)
**Recommended Test**:
- **ID**: `1.001-INT-007` (already designed, P2 priority)
- **Type**: Integration with visual testing (Percy, Chromatic)
- **Description**: Automated screenshot comparison against approved designs

**Mitigation**: Manual design review in PR until automated testing implemented

### Gap 2: Accessibility Compliance

**Requirement**: DoD - Accessibility compliance (WCAG AA)
**Current Coverage**: PARTIAL (no automated tests)
**Severity**: MEDIUM (regulatory risk, UX impact)
**Recommended Test**:
- **ID**: `1.001-E2E-006` - Accessibility audit
- **Type**: E2E with axe-core
- **Description**: Automated WCAG AA violation detection

**Mitigation**: Manual accessibility review using browser DevTools until automated

---

## Requirements Not Testable (Addressed by Process)

### Documentation for module creators

**Why not tested**: Documentation quality is subjective
**Verification method**: Technical writing review, user testing with teachers
**DoD check**: Documentation exists and is reviewed

### Code review approved

**Why not tested**: Human review process
**Verification method**: PR approval from senior developer
**DoD check**: Approved PR merged to main

---

## Test Coverage by Requirement Type

| Requirement Type | Total | Full Coverage | Partial | None |
|---|---|---|---|---|
| Acceptance Criteria | 3 (12 sub) | 10 | 2 | 0 |
| Performance | 4 | 4 | 0 | 0 |
| Security | Implicit | 5 tests | 0 | 0 |
| Definition of Done | 9 items | 4 tested | 2 partial | 3 process |

**Overall**: 83% full coverage, 17% partial, 0% gaps

---

## Given-When-Then Summary by AC

### AC-1 Summary (8 tests)

**Given**: Valid and invalid JSON configurations
**When**: Parsing, validation, loading, and initialization occur
**Then**: Correct components load with proper state, errors are rejected

**Critical Path**: JSON → Validation → Component Lookup → State Init

### AC-2 Summary (9 tests)

**Given**: Parsed configuration with parameters
**When**: Dynamic rendering occurs
**Then**: Correct UI displays with proper styling and responsiveness

**Critical Path**: Config → Component Props → DOM Render → Visual Validation

### AC-3 Summary (9 tests)

**Given**: Various error scenarios (network, parsing, runtime)
**When**: Errors occur during any lifecycle phase
**Then**: Friendly messages shown, errors logged, system remains stable

**Critical Path**: Error → Boundary Catch → User Message + Logging → Recovery

---

## Test Data Scenarios Mapped

### Happy Path Scenarios (Green)

1. **Valid Config → Successful Render** (3 variations: M1, M5, M14)
   - Tests: INT-003, INT-004, INT-005, E2E-001

2. **Responsive Layouts** (3 viewports)
   - Tests: INT-006

### Error Scenarios (Red)

3. **Invalid JSON Structure**
   - Tests: UNIT-002

4. **Unknown Module Type**
   - Tests: UNIT-003, SEC-002

5. **Type Mismatches**
   - Tests: UNIT-004

6. **Network Failures**
   - Tests: E2E-003, E2E-005

7. **Component Errors**
   - Tests: INT-008, INT-009

### Edge Cases (Yellow)

8. **Performance Boundaries**
   - Tests: UNIT-013 (<100ms), UNIT-014 (<2s), INT-011 (<50MB)

9. **Multi-Module Scenarios**
   - Tests: INT-012 (3 modules), INT-013 (5 modules)

10. **Security Payloads**
    - Tests: SEC-001 through SEC-005

---

## Risk-Based Test Priority

### P0 Tests (Must Pass - Block Release)

- **AC-1**: UNIT-001, UNIT-002, UNIT-003, INT-001, INT-002
- **AC-2**: INT-003, INT-004, INT-005
- **AC-3**: INT-008, INT-009, E2E-003
- **Security**: SEC-001 through SEC-005
- **Performance**: UNIT-013, INT-011

**Rationale**: Core functionality, security, critical error handling, baseline performance

### P1 Tests (Should Pass - Ship with Known Issues)

- **AC-1**: UNIT-004, UNIT-005
- **AC-2**: UNIT-006, UNIT-007, INT-006, E2E-001, E2E-002
- **AC-3**: UNIT-010, UNIT-011, E2E-004
- **Performance**: UNIT-014, INT-012

**Rationale**: User experience, error messages, multi-module support

### P2 Tests (Nice to Have - Future Optimization)

- **AC-2**: UNIT-008, INT-007
- **Performance**: INT-013, E2E-005

**Rationale**: Visual polish, stress testing, slow network edge cases

---

## Traceability Matrix Export

### CSV Format (for import to test management tools)

```csv
Requirement ID,Requirement Description,Test ID,Test Level,Priority,Coverage,Notes
AC-1.1,Parse configuration without errors,1.001-UNIT-001,Unit,P0,FULL,Valid JSON parsing
AC-1.1,Parse configuration without errors,1.001-INT-001,Integration,P0,FULL,Load runtime with config
AC-1.2,Validate against module schema,1.001-UNIT-002,Unit,P0,FULL,Reject invalid JSON
AC-1.2,Validate against module schema,1.001-UNIT-003,Unit,P0,FULL,ModuleType whitelist (security)
AC-1.2,Validate against module schema,1.001-UNIT-004,Unit,P1,FULL,Config parameter types
AC-1.2,Validate against module schema,1.001-SEC-001,Security,P0,FULL,XSS injection attempts
AC-1.3,Load appropriate React component,1.001-UNIT-006,Unit,P0,FULL,Component resolution logic
AC-1.3,Load appropriate React component,1.001-INT-003,Integration,P0,FULL,Render BateriaRápida
AC-1.3,Load appropriate React component,1.001-INT-004,Integration,P0,FULL,Render IdentificaOperação
AC-1.3,Load appropriate React component,1.001-INT-005,Integration,P0,FULL,Render AutoAvaliação
AC-1.4,Initialize module state correctly,1.001-INT-002,Integration,P0,FULL,State initialization
AC-1.4,Initialize module state correctly,1.001-E2E-001,E2E,P1,FULL,Config-to-render flow
AC-2.1,Display correct UI based on module type,1.001-INT-003,Integration,P0,FULL,BateriaRápida UI
AC-2.1,Display correct UI based on module type,1.001-INT-004,Integration,P0,FULL,IdentificaOperação UI
AC-2.1,Display correct UI based on module type,1.001-INT-005,Integration,P0,FULL,AutoAvaliação UI
AC-2.1,Display correct UI based on module type,1.001-E2E-002,E2E,P1,FULL,Student interaction
AC-2.2,Apply configuration parameters,1.001-UNIT-007,Unit,P1,FULL,Parameter application
AC-2.2,Apply configuration parameters,1.001-INT-003,Integration,P0,FULL,Params in BateriaRápida
AC-2.3,Maintain responsive design (1024px+),1.001-INT-006,Integration,P1,FULL,Responsive layouts
AC-2.4,Follow design system,1.001-UNIT-008,Unit,P1,PARTIAL,Design token usage
AC-2.4,Follow design system,1.001-INT-007,Integration,P2,PARTIAL,Visual regression (future)
AC-3.1,Display friendly error message,1.001-UNIT-010,Unit,P0,FULL,Error message generation
AC-3.1,Display friendly error message,1.001-INT-008,Integration,P0,FULL,Error boundary UI
AC-3.1,Display friendly error message,1.001-E2E-004,E2E,P1,FULL,User error recovery
AC-3.2,Log technical details,1.001-UNIT-011,Unit,P0,FULL,Error logging
AC-3.2,Log technical details,1.001-INT-008,Integration,P0,FULL,Log to external service
AC-3.3,Gracefully fallback to safe state,1.001-INT-008,Integration,P0,FULL,Fallback UI
AC-3.3,Gracefully fallback to safe state,1.001-E2E-003,E2E,P0,FULL,Network failure degradation
AC-3.4,Allow continuation with other modules,1.001-INT-009,Integration,P0,FULL,Module isolation
AC-3.4,Allow continuation with other modules,1.001-E2E-003,E2E,P0,FULL,Other modules functional
PERF-1,Module initialization <2s,1.001-UNIT-014,Unit,P1,FULL,Init time measurement
PERF-1,Module initialization <2s,1.001-E2E-005,E2E,P2,FULL,3G network test
PERF-2,Configuration validation <100ms,1.001-UNIT-013,Unit,P0,FULL,Validation performance
PERF-3,Memory usage <50MB per module,1.001-INT-011,Integration,P0,FULL,Memory profiling
PERF-3,Memory usage <50MB per module,1.001-INT-013,Integration,P2,FULL,5 modules stress test
PERF-4,Graceful degradation slow connections,1.001-E2E-005,E2E,P2,FULL,Slow 3G simulation
DOD,Accessibility WCAG AA,1.001-E2E-006,E2E,P1,NONE,Gap - Add axe-core audit
```

---

## Recommendations for Implementation

### Phase 1: Create Test Infrastructure (Week 1)

1. **Set up test frameworks**: Vitest + React Testing Library + Playwright
2. **Create test data fixtures**: Valid/invalid configs in shared module
3. **Configure coverage reporting**: c8 with 90% threshold
4. **Set up CI pipeline**: Run unit tests on every commit

### Phase 2: Implement P0 Tests (Weeks 2-3)

1. **Unit tests**: UNIT-001 through UNIT-006, UNIT-009 through UNIT-011, UNIT-013
2. **Integration tests**: INT-001 through INT-005, INT-008, INT-009, INT-011
3. **E2E tests**: E2E-003
4. **Security tests**: SEC-001 through SEC-005

**Gate**: Cannot proceed to implementation without P0 test suite ready

### Phase 3: Implement P1 Tests (During Development)

1. **Add remaining unit tests** as components are built
2. **Add integration tests** as features are integrated
3. **Add E2E tests** for user journeys

### Phase 4: Address Gaps (Pre-Launch)

1. **Add accessibility testing**: Integrate axe-core (1.001-E2E-006)
2. **Set up visual regression**: Implement Chromatic or Percy (1.001-INT-007)
3. **Performance monitoring**: Add RUM for production insights

---

## Key Principles Applied

✓ **Every requirement testable**: All ACs mapped to specific tests
✓ **Given-When-Then clarity**: Clear test scenarios for each requirement
✓ **Risk-based prioritization**: P0 tests cover critical security and core functionality
✓ **Multi-level coverage**: Unit for logic, integration for components, E2E for journeys
✓ **Gap identification**: 2 gaps identified with clear mitigation plans
✓ **Actionable recommendations**: Phased test implementation plan provided

---

## Integration with Quality Gates

**Gate Trace Block** (for inclusion in gate file):

```yaml
trace:
  totals:
    requirements: 12
    full: 10
    partial: 2
    none: 0
  coverage_pct: 83
  planning_ref: 'docs/qa/assessments/1.001-test-design-20251001.md'
  uncovered:
    - ac: 'AC-2.4'
      reason: 'Visual regression testing not automated (P2)'
      mitigation: 'Manual design review in PR'
    - ac: 'DoD-Accessibility'
      reason: 'Automated WCAG testing not yet implemented'
      mitigation: 'Manual DevTools audit, add 1.001-E2E-006 before launch'
  notes: 'Strong traceability - all requirements mapped to test scenarios'
```

**Recommended Gate Status Contribution**: PASS (with noted gaps acceptable for MVP)
